---
title: "Antibody dynamics in asymptomatic and symptomatic COVID-19 patients in a Romanian hospital"
author: "author"
#bibliography: "references.bib"
output:
  word_document:
    keep_md: yes
    fig_caption: yes
    fig_height: 7.5
    fig_width: 3
    toc: no
    reference_docx: word_template.docx
  html_document: 
    keep_md: yes
    df_print: kable
    theme: readable
    fig_caption: yes
    fig_height: 3
    fig_width: 7.5
    number_sections: yes
    toc: yes
    toc_depth: 4
    toc_float: no
---

# Background

As of September 25, 2020, the coronavirus disease 2019 (COVID-19) pandemic, caused by SARS-CoV-2, has  affected more than 32 million people around the world (WHO). Many patients with SARS-CoV-2 infections have reportedly had mild to severe respiratory illness occurring 2–14 days after exposure.
<!-- [@albertsHepatitisVirusSeroprevalence2018; @alghamdiLongtermEfficacyHepatitis2013a] -->


Our understanding of the immune responses in mild and more severe infections is better now, still the protective immune profiles are not well defined.
According to ECDC and CDC the most widely used tests in the current situation are based on on the detection of SARS-CoV-2 RNA by nucleic acid amplification tests such as reverse-transcription polymerase chain reaction (RT-PCR) and antibody detection as auxiliary testing tool, significant for diagnosis and epidemiological investigation of COVID-19 cases.

Viral (nucleic acid) detection tests has become the standard method to check samples from the respiratory system (nasal, oral swabs or saliva) to establish the presence of COVID-19 infection in symptomatic and asymptomatic individuals. 
Antibody tests are not recommended to diagnose SARS-CoV-2 infection as the sole basis for diagnosis of acute infection (ECDC, CDC). 
Serologic assays may be used to support clinical assessment of persons when used in conjunction with viral detection tests including the post-infectious syndrome caused by SARS-CoV-2 infection (e.g. Multisystem Inflammatory Syndrome in Children) (CDC). 
Serological test methods for the detection of anti-SARS-CoV-2 IgG and IgM antibody include enzyme-linked immunosorbent assay (ELISA), chemiluminescent immunoassay (CLIA), and lateral flow immunoassay (LFIA) (Wang, CDC, ECDC). Antibodies specific for the major SARS-CoV-2 antigens, including the S protein which binds the cellular receptor for viral entry and the N protein necessary for viral replication, have been detected in patients (Seow, Wang Atyeo).

Upon coronavirus infection, IgM are produced as an early immune response after infection but in the first 10 days, the testing sensitivity is 58.4% (45.5% - 70.3%), higher in days 15-21 was 75.4% (64.3% - 83.8%) with a specificity in all time points of 98.7% (97.4-99.3) (Watson). 
IgG are developed simultaneously with IgM, with a similar testing sensitivity and specificity in the first 10 days and much higher in days 15-21 [sensitivity 88.2 (83.5-91.4) and 99.1 specificity (98.3-99.6)] (Watson). Antibody detection in mild cases can take longer time (four weeks or more) and in a small number of cases antibodies (IgM, IgG) are not detected at all (at least during the studies’ time scale). 

In Romania, from the beginning of epidemic until June 23, hospitalization was mandatory even in asymptomatic and mild infections, discharge was possible only after 2 consecutive RT-PCR SARS-CoV-2 tests (Law 55/2020, Exec. Ord 1137 / 2020). 
Then, to end of this study, hospitalization was mandatory for all cases for at least 10 days (Law 55/2020, Exec. Ord 1321 / 2020, Exec. Ord 1513 / 2020). 
Therefore the hospitalization was rather long for many of the study subjects, including asymptomatic cases, which allowed repeated antibody testing at more than 10 days since confirmation.

# Methods

```{r setup, echo=F, fig.height=4, fig.width=7, message=FALSE, warning=FALSE, dpi=144, include=T, results="asis"}

library(tidyverse)
library(magrittr)
#library(ggExtra) # ggMarginal()
#library(cowplot) # plot_grid
library(ggpubr)
library(ggthemes)
#library(ggcorrplot)
#library(GGally) #ggpairs
#library(dplyr)
library(readxl)
library(grid)

library(pander)
panderOptions('digits', 2)
panderOptions('round', 2)
panderOptions('keep.trailing.zeros', TRUE)
options(scipen = 999)
options(digits = 3)

library(knitr)
#library(kableExtra)

library(ggfortify)
library(survival)

library(Hmisc)
#library(stringr)
#library(DescTools)


options(knitr.table.format = "pandoc")

knitr::opts_chunk$set(comment = NA)

library(captioner)
fig_caption <- captioner::captioner("Figure")
tab_caption <- captioner::captioner("Table")

options(knitr.table.format = "pandoc")

MAIN.FONT <- "Arial"

# set orthogonal contrasts
# options(contrasts = c("contr.sum", "contr.poly"))
# regular contrasts
# options(contrasts = c("contr.treatment", "contr.poly"))

set.seed(1)
#```

#```{r Source scripts, message=F, warning=F, echo=F, results='hide'}
base_path = "~/Dropbox/Stats/"

source(paste0(base_path, 'R library/search_for_variable.R'), echo=F)
source(paste0(base_path, 'R library/mySSby.R'), echo=F)
source(paste0(base_path, 'R library/mySSby3.R'), echo=F) # replace finalfit
source(paste0(base_path, 'R library/describe_numerice1.R'), echo=F)
source(paste0(base_path, 'R library/contingency.R'), echo=F)
source(paste0(base_path, 'R library/describe2x2_v1.R'), echo=F)
source(paste0(base_path, 'R library/mytheme.R'), echo=F)
source(paste0(base_path, 'R library/assorted bits.R'), echo=F)
source(paste0(base_path, 'R library/custom_charts.R'), echo=F)

# theme_set(my_theme(base_theme = theme_grey))

setwd(paste0(base_path, "2020/Covid clinic"))
#```

#```{r Import data, echo=F, message=F, warning=F, fig.height=4, fig.width=6}

metadata <- suppressWarnings(read_excel("DB1.xlsx", sheet = "metadata"))

database <- suppressWarnings(read_excel("DB1.xlsx", col_types = metadata$Type)) %>% 
  labelled::set_variable_labels(.labels = metadata$Var) %>% 
  mutate_at(metadata$ID[ #metadata$Type %in% c("text") & 
              metadata$Role %in% c("danu" ,"binary", "factor", "ordered", "likert")], as.factor_metadata, metadata=metadata, debug=F) %>% 
  labelled::set_variable_labels(.labels = metadata$Label) %>%
  filter(`Exclude` == "no") %>%
  select(-c(metadata$Var[metadata$Role=="exclude"])) %>%
  select(-c(metadata$Var[metadata$Role=="id"]))

#summary(database)

## auto-update metatata with missing values
metadata <- make_metadata(database, existing.metadata = metadata)
#write.csv(metadata, "metadata.csv", na = "")

## groups of variables
my.groups <- list()
for (gr in unique(na.omit(metadata$Group))) {
  my.groups[[gr]] <- make_groups_metadata(gr, metadata)
}


for (s in metadata$Var[metadata$Role == "separate"]) {
  #print(s)
  temp <- separate_metadata(database, s, metadata = metadata, exact = F, add.prefix=F)
  #group <- metadata$Group[metadata$Var == s]
  group <- metadata.var_to_labels(s, metadata)

  # temp <- labelled::set_variable_labels(temp, .labels = names(temp))

  for (x in 1:ncol(temp))
    if (names(temp)[x] %in% names(database))
      names(temp)[x] <- names(temp) %+% " "

  database %<>% select(-c(s)) %>% bind_cols(temp)
  my.groups[[group]] <- names(temp)
  metadata <- make_metadata(DB = database, vars = names(temp), existing.metadata = metadata,
                            label = as.character(labelled::var_label(temp)),
                            group = group)

}

database %<>% select(unlist(my.groups, use.names = F))

database %<>% 
  mutate(`Severity` = forcats::fct_collapse(`Clinical form`,
                                            `asymptomatic or mild` = c("asymptomatic", "mild"),
                                            `moderate to critical` = c("intermediate", "severe", "critical")),
         `Severity` = factor(`Severity`, levels=c("moderate to critical", "asymptomatic or mild"))
         ) 

#```

#```{r second database, echo=F, message=F, warning=F, fig.height=4, fig.width=6}

## make a second database (long format instead of wide) for some analyses
IgGs = "IgG " %+% 1:5
IgMs = "IgM " %+% 1:5
PCRs = "RT - PCR " %+% 1:5
test_days = "Test " %+% 1:5 %+% " (days)"


DB <- bind_cols( 
  database %>% select(c(test_days, "FO", "Confirmation date", "Clinical form", "Severity")) %>% 
    tidyr::gather("dontcare", "Days since confirmation", test_days) %>% 
    select(c("Days since confirmation", "FO", "Confirmation date", "Clinical form", "Severity")), #%>% 
    # mutate(`Severity` = forcats::fct_collapse(`Clinical form`, 
    #                                           `asymptomatic or mild` = c("asymptomatic", "mild"),
    #                                           `moderate to critical` = c("intermediate", "severe", "critical"))),
  database %>% select(c(PCRs)) %>% tidyr::gather("dontcare", "RT - PCR", PCRs) %>% 
    select(c("RT - PCR")) %>% mutate(`RT - PCR` = factor(`RT - PCR`, levels = c("detectable", "negative"))),
  database %>% select(c(IgMs)) %>% tidyr::gather("dontcare", "IgM", IgMs) %>% select(c("IgM")),
  database %>% select(c(IgGs)) %>% tidyr::gather("dontcare", "IgG", IgGs) %>% select(c("IgG"))
) #%>% na.omit() # %>% mutate(`Log IgM` = log2(`IgM`), `Log IgG` = log2(`IgG`))

## make some metadata for it
metadata_DB = make_metadata(DB, existing.metadata = metadata)
metadata_DB %<>% filter(`Var` %!in% c("IgM", "IgG", "RT - PCR"))
metadata_DB$Var[metadata_DB$Var == "IgM 1"] = "IgM"
metadata_DB$Var[metadata_DB$Var == "IgG 1"] = "IgG"
metadata_DB$Var[metadata_DB$Var == "RT - PCR 1"] = "RT - PCR"
metadata_DB$Label[metadata_DB$Var == "IgM"] = "IgM"
metadata_DB$Label[metadata_DB$Var == "IgG"] = "IgG"
metadata_DB$Label[metadata_DB$Var == "RT - PCR"] = "RT - PCR"

# ```
# 
# # KM plots
# 
# ```{r my_surv_plot, echo=F, fig.height=3, fig.width=5, message=F, warning=F, dpi=600, results="asis", include=T}
require("survival")

my_surv_plot <- function(DB2, Time, by = NA, Status = NA, Status_event="dead",
                         # sf_times = c(7, 14, 21, 28),
                         hr_config_ord = "vs first", # "vs last"
                         hr_config_bin = "vs second", 
                         show_logrank = T,
                         surv.connect = T, conf.int = T, conf.int.alpha = 0.1,
                         censor = T, censor.size = 2.5, censor.shape = "|", 
                         lwd=1, median.lwd=0.5, median.linetype = "dashed",
                         metadata = NULL) {
  # by="Clinical form"
  
  # make a censor variable named Status, either all not censored, or from a named variable
  if (is.na(Status)) {
    DB2$Status = T # all ok
  } else {
    DB2$Status = DB2[[Status]] == Status_event # TRUE if ok, false if censored
  } 
  
  db <- DB2 %>% 
    select(c(Time, Status, by)) %>%
    mutate(nothing = "") %>%
    set_colnames(c("Time", "Status", make.names(by), "nothing")) %>% 
    na.omit() %>% droplevels()
  #summary(db)
  
  ## fit: regular log-rank test
  fit <- with(db, survfit(formula=as.formula("Surv(time = `Time`, event = `Status`) ~ " %+% make.names(by)) ))
  test <-with(db, survival::survdiff(as.formula("Surv(time = `Time`, event = `Status`) ~ " %+% make.names(by))))
  LR.p <- pchisq(test$chisq, length(test$n)-1, lower.tail = F)
  
  # sf <- summary(fit, times=sf_times)
  #print(sf)
  #sf$table %>% as.data.frame()
  # sf <- summary(fit)
  
  surv_median <- as.vector(summary(fit)$table[, "median"])
  df_fit <- data.frame(
    strata2 = names(fit$strata) %>% str_remove_all(make.names(by) %+% "="),
    x1 = surv_median, x2 = surv_median, 
    y1 = rep(0, length(surv_median)), 
    y2 = rep(0.5, length(surv_median)))
  
  
  
  ## fit2: coxh regression
  levs <- levels(DB2[[by]])
  if(length(levs) > 2) {
    if (hr_config_ord == "vs first") { # compare all levels to the first (default)
      db2 <- db
    } else if (hr_config_ord == "vs last") {
      db2 <- db %>% mutate_at(c( make.names(by)), forcats::fct_rev)
    } 
  } else { #if(length(levs) == 2) {
    if (hr_config_bin == "vs first") { # no vs yes
      db2 <- db
    } else { # if (hr_config_ord == "vs second") { # yes vs no (default)
      db2 <- db %>% mutate_at(c(make.names(by)), forcats::fct_rev)
    }
  }
  fit2 <- with(db2, coxph(formula=as.formula("Surv(time = `Time`, event = `Status`) ~ " %+% make.names(by)) ))
  # text_HR = "HR = " %+% scales::number(exp(fit2$coefficients), 0.001) 
  
  
  ## KM plot
  plt <- autoplot(fit, surv.connect = surv.connect, 
                  size=lwd, # Does not work!!!
                  conf.int = conf.int, conf.int.alpha = conf.int.alpha,
                  censor = censor, censor.size = censor.size, censor.shape = censor.shape) +
    scale_color_discrete(metadata.var_to_labels(by, metadata))+
    scale_fill_discrete(metadata.var_to_labels(by, metadata))+
    # scale_color_viridis_d(by) + scale_fill_viridis_d(by)+
    
    # annotate('text', label=text_HR %+% "\n" %+% text_LR, x = 33.5, y=0.7, size=3, hjust=0) +
    geom_hline(yintercept=0.5, size=0.5, color="grey") +
    geom_vline(aes(xintercept=x1, color=strata2), data=df_fit, linetype = median.linetype, size = median.lwd) 
  
  if (show_logrank == T) {
    plt <- plt + labs(subtitle = "Log-rank test: " %+% scales::pvalue(LR.p, add_p = T) )
    # plt <- plt + labs(y = "Log-rank test: ")
  }
  
  attr(plt, "fit") = fit
  attr(plt, "test") = test
  attr(plt, "p-value") = LR.p
  attr(plt, "fit2") = fit2 # coxh
  
  plt  
  #return (plt)
  
  
  # survminer::pairwise_survdiff(as.formula("Surv(time = `Survival`, event = `Dead`) ~ " %+% make.names(by)), data=db) %>% print()
  
  # db2 <- db %>% filter(Treatment != "Transplant") %>% droplevels()
  # survminer::pairwise_survdiff(as.formula("Surv(time = `Survival`, event = `Dead`) ~ " %+% by), data=db2) %>% print()
  
  

}

last_available <- function(x) {
  x <- na.omit(x)
  if (length(x) == 0) return (NA)
  else return (x[length(x)])
}

first_match_or_last_known <- function(x, pattern = "") {
  x <- na.omit(x)
  y <- grep(x=x, pattern = pattern, value = T )
  # x = x[x == T]
  if (length(y) == 0) return (x[length(x)])
  else return (y[1])
}
```

In this study, we investigated the patterns of antibody response to SARS-CoV-2 in patients with COVID-19 for better understanding the humoral immunological response during SARS-CoV-2 infection. 

## Patients

We retrospectively analyzed data from all consecutive patients with a confirmed COVID-19 diagnosis treated at The Teaching Hospital of Infectious Diseases Cluj-Napoca Romania from April 1 to September 23, 2020, who had at least one SARS-CoV-2 specific IgM or IgG determination. 
Data received from our hospital’s electronic database consisted of all RT-PCR, IgM and IgG determinations for SARS-CoV-2, along with demographic, clinical data, laboratory tests, and CT scan results. 
All patients were diagnosed according to the pneumonia diagnosis protocol for SARS-CoV-2 infection.

A total number of 469 patients diagnosed with SARS-CoV-2 infection in The Teaching Hospital of Infectious Diseases Cluj-Napoca, Romania from February 27 to September 23, 2020, were included. 
For ease of analysis, we separated cases into “asymptomatic or mild” and “moderate to critical” disease. 
Severity was defined based on the symptoms and clinical condition according to WHO interim guidance and NHI criteria. 
Briefly, mild cases were defined by some symptoms but no shortness of breath, dyspnea, or abnormal chest imaging while moderate/severe/critical cases were defined by the evidence of lower respiratory disease and a more severe clinical picture (Table 1).

## RT-PCR tests

Between 28.02.2020 - 23.04.2020 the testing of SARS CoV-2 RNA extraction was done with the Qiasymphony automatic extractor (Qiagen) and the amplification and detection with the Rotorgene RT-PCR device (Qiagen). 
The extraction of the genetic material was done with Qiagen kits from one ml of sample. 
The amplification kits used to detect the virus were chosen according to WHO recommendations, using the CDC and Charite-Berlin protocols. 
The kits were used: Quantabio qScript XLT One-Step RT-qPCR ToughMix, Viroreal (Ingenetix) - with detection limit at 95% of cases (LoD95) of 13 target copies / reaction, EliGene (Elisabeth Pharmacon) - with analytic sensitivity of 15 target copies/ reaction and 100% analytic specificity. 
From the end of April, the detection of SARS CoV-2 RNA began to be done on the automatic RT-PCR system NeuMoDx (Qiagen), initially with NeuMoDx 98, and later until nowadays with NeuMoDx 288 which has a higher testing capacity. 
The method ensures the automatic flow of all necessary RT-PCR steps, targeting the NSP2 protein and the N gene of the SARS CoV-2 genome. The detection limit is 150 copies/ ml.SARS-CoV-2 nucleic acid test results from Ct (Cycle threshold) value interpretation was subject to the manufacturer's specification, and the suspected results were notified of clinical resampling review. 

## Serological tests

Serological tests were performed between 14.04.2020 - 25.09.2020, (1731 anti-SARS-CoV-2 antibodies type IgG and 1483 anti-SARS-CoV-2 antibodies IgM type). 
Most of the tests were performed by electrochemiluminescence with the eCL8000 analyzer (Shenzhen, China), only 101 tests anti-SARS-CoV-2 IgG type antibodies were done by EIA technique. 
The kits used to detect anti-SARS CoV-2 antibodies type IgM and IgG are designed based on the enzymatic sandwich principle, the diluted sample being reacted with biotinylated N proteins (N), the receptor binding domain (RBD) of SARS- CoV-2 spike protein (S) and mouse IgM antibodies marked with a ruthenium complex and microparticles coated with Streptavidin. 
For both antibody types, the thresholds for detectable and positive measurements were 0.8 and 1.2, respectively. We decided to separate patients into high / low reactivity based on IgM and IgG values at a 75% quartile threshold: patients who had at least 1 antibody measurement above the 75% quartile of all measurements in the database (2.906 for IgG and 2.607 for IgM) were classified as “higher reactivity” while the others were classified as “lower reactivity” for IgM and IgG, respectively. 

For ease of analysis, we coded severity "asymptomatic to mild" and "moderate to critical" clinical forms. Both antibodies had higher average and higher variability in patients with more severe forms, suggesting that severity is linked to a higher immune reactivity, at least in a subset of patients. We decided to separate patients into high / low reactivity based on IgM and IgG values at a 75% quartile threshold: patients who had at least 1 antibody measurement above the 75% quartile of all measurements in the database (2.906 for IgG and 2.607 for IgM) were classified as "high reactivity" while the others were classified as "lower reactivity" for IgM and IgG, respectively.

## Statistical analyses

R 4.0 was used for statistical analyses. Qualitative data was expressed as count (%) and quantitative data as mean ± standard deviation and/or median (interquatile range) depending on distribution normality. Log2-transformed data and geometric mean ± geometric standard deviation was used for antibody titres. Hypotheses testing was performed using odds-ratio with 95% confidence intervals and p-value from Fisher tests or Mann-Whitney test, as appropriate. Reverse cumulative distribution (Kaplan Meier) plot, hazard ratio and a log-rank test was used for the RT-PCR negativation rate by time since confirmation and severity. A probit regression was used to estimate the average proportion of patients with detectable antibodies or negative RT-PCR result at individual time-points after confirmation.

# Results

## Summary table by clinical form

The final dataset included 469 patients (Table 1), with almost equal gender distribution and a mean age of 42. More than half of the subjects remained asymptomatic or only developed a mid disease during follow-up. Significant differences were observed between these patients and those who developed more severe presentations: higher male proportion, older age and longer hospitalization. CT examination revealed specific abnormalities in 62.4% of the moderate to critical cases, of whom more than half had at least 30% lung area affected.

```{r echo=F, fig.height=4, fig.width=7, message=F, warning=F, dpi=144, results="asis", include=T}
cat("\n\n")
cat(tab_caption("t severity demographics", "Sample characteristics by clinical severity."))
cat("\n\n")

database %>%
  mutate_at(c("Sex"), forcats::fct_rev) %>%
  mutate(`Sex: male` = forcats::fct_recode(`Sex`, yes="M", no="F"),
         `CT: crazy paving and/or ground-glass opacities` = forcats::fct_recode(`CT scan`, 
              yes=levels(database$`CT scan`)[1], no=levels(database$`CT scan`)[2]),
         `CT: >30% lung area damage` = forcats::fct_recode(`CT - Lung damage`, 
              yes=levels(database$`CT - Lung damage`)[1], no=levels(database$`CT - Lung damage`)[2])) %>%
  
  select(c("Severity", "Age (years)",
           "Sex", #"Sex: male", 
           "Hospitalization (days)",
           "CT: crazy paving and/or ground-glass opacities", "CT: >30% lung area damage")) %>%  # DescTools::Desc()
  
  make_summary_table(g.rows = c("mean_sd", "med_range"), 
                     #g.rows = c("N%", "mean_sd", "geo_mean", "med_range", "med_iqr"), 
                     med_range_string = "M (range)",
                     dep="Severity",
                     bold_signif = F,
                     footnote = list(lang="en", values = c("mean_sd", "med_range", "MW", "OR", "custom"),
                                     custom = "* no abnormalities on chest X-ray but marginal non-specific findings on CT"),
                     header=list(lang="en", columns = c("Factor", "Levels", "Total", "Statistics"),
                                 labels = list(`Factor` = "", `Levels` = "", `Total` = "Overall", `Statistics` = "")),
                     metadata = metadata) %>%
  flextable::compose(i=8, j=4, part = "body", flextable::as_paragraph(flextable::as_chunk('6 (2.3%) *')) ) %>%
  flextable::compose(i=c(8, 9), j=6, part = "body", flextable::as_paragraph(flextable::as_chunk('')) )

## * no abnormalities on chest X-ray but marginal non-specific findings on CT.
```

## PCR, IgM, IgG by time since confirmation

A total of 1199 RT-PCR and 571 IgM & IgG paired measurements were included, most of which were performed during the first two weeks after confirmation (Table 2).
RT-PCR and serological tests were performed at different time intervals, depending on the confirmation date until discharge (on average 2.21 test / person). At 7-14 days after confirmation, two thirds of RT-PCR tests were positive and IgM/IgG antibodies were detectable at low median values. * At 8-14 days ... *

```{r echo=F, fig.height=3, fig.width=5, message=F, warning=F, dpi=600, results="asis", include=T}  

cat("\n\n")
cat(tab_caption("t trends", "Dynamics of RT-PCR (positive n and %), IgM and IgG titre (geometric mean ± standard deviation, median, interquartile range) by time since confirmation, in patients who were still under follow-up. Until June 23, hospitalization was mandatory even in asymptomatic and mild infections, discharge was possible only after 2 consecutive negative RT-PCR tests."))
cat("\n\n")

DB %>% 
  mutate (`Time since confirmation (days)` = cut(`Days since confirmation`, 
                           breaks=c(-Inf, 3, 7, 14, 21, 28, Inf),
                           labels = c("≤3", "4-7", "8-14", "15-21", "22-28", "≥29"), 
                           right=T) %>% factor) %>%
  mutate(`Positive RT - PCR` = forcats::fct_recode(`RT - PCR`, `yes` = "detectable", `no` = "negative")) %>%
  mutate(`Antibodies tests *` = factor(is.na(`IgM` + `IgG`)) %>% forcats::fct_recode(`yes` = "FALSE", `no` = "TRUE")) %>%
  mutate(`Detectable IgM` = ifelse(is.na(`IgM`), NA, ifelse(`IgM`<0.8, "no", "yes")) %>%
                factor(levels = c("yes", "no"))) %>%
  mutate(`Detectable IgG` = ifelse(is.na(`IgG`), NA, ifelse(`IgG`<0.8, "no", "yes")) %>%
                factor(levels = c("yes", "no"))) %>%
  
  mutate(`RT - PCR tests` = `Time since confirmation (days)`) %>% # ! just rename, anesthetic reasons
  select(c("RT - PCR tests","Positive RT - PCR", "Antibodies tests *", "IgM", "Detectable IgM", "IgG", "Detectable IgG")) %>% 
  make_summary_table(dep="RT - PCR tests", prefer="parametric",
                     # metadata = make_metadata(db, existing.metadata = metadata),
                     #g.rows = c("N%", "mean_sd", "geo_mean", "med_range", "med_iqr"), 
                     g.rows = c("geo_mean", "med_iqr"), #med_iqr_string = "M (IQR)",
                     bold_signif = F, 
                     footnote = list(lang="en", values = c("geo_mean", "med_iqr", "custom"),
                                     custom = "* total IgM & IgG paired determinations, relative to RT-PCR tests during the same period (both antibodies were measured simultaneously)."),
                     header=list(lang="en", columns = c("Factor", "Levels"),
                                 labels = list(`Factor` = "Time since confirmation (days)", `Levels` = ""))
                     )


```

Due to stringent regulations, all patients were tested at least once after confirmation and half of the cases in each group (asymptomatic or mild vs. moderate to critical, log-rank test: p=0.001) had the first undetectable result at 15 days [95% CI: 13-18] and 17 days [95% CI: 16-21], respectively (Figure 1). At 28 days after confirmation, 93.1% of asymptomatic or mild and 75.8%  of moderate to critical cases had at least 1 negative RT-PCR test.

```{r echo=F, fig.height=3, fig.width=5, message=F, warning=F, dpi=600, results="asis", include=T}

last_status_PCR <- 
  DB %>% select(c("FO", "Days since confirmation", "RT - PCR")) %>%
    na.omit() %>%
    arrange(`FO`, `Days since confirmation`) %>%
    mutate(key = `RT - PCR` %+% " " %+% `Days since confirmation`) %>%
    group_by(`FO`) %>%
    summarise(`key` = first_match_or_last_known(`key`, pattern = "nega")) %>%
    tidyr::separate(col="key", into=c("Stauts at test #5", "Days since confirmation"), convert=T) %>%
    mutate(`Stauts at test #5` = factor(`Stauts at test #5`, levels=c("detectable", "negative")))

DB2_PCR <- database %>%
  select(c("FO", "Clinical form")) %>%
  mutate(`Severity` = forcats::fct_collapse(`Clinical form`, 
                                                 `asymptomatic or mild` = c("asymptomatic", "mild"),
                                                 `moderate to critical` = c("intermediate", "severe", "critical")) %>%
           factor(levels=c("asymptomatic or mild", "moderate to critical")) ) %>%
  mutate(`Severitate` = forcats::fct_collapse(`Clinical form`, 
                                              `asymptomatic` = c("asymptomatic"),
                                              `mild` = c("mild"),
                                              `moderate` = c("intermediate"),
                                              `severe to critical` = c("severe", "critical")) %>%
           factor(levels=c("asymptomatic", "mild", "moderate", "severe to critical"))) %>%
  merge(last_status_PCR, by="FO") 

# ```
# 
# ```{r echo=F, fig.height=3, fig.width=5, message=F, warning=F, dpi=600, results="asis", include=T}
plt2_PCR <- DB2_PCR %>%
  my_surv_plot(by="Severity", Time = "Days since confirmation", 
               Status = "Stauts at test #5", Status_event = "negative",
               hr_config_bin = "vs first", show_logrank = F,
               conf.int.alpha = 0.1, lwd = 1, median.lwd = 0.33,
               metadata = metadata)


# plt2_PCR
# summary(attr(plt2_PCR, "fit2"))
hr.table_PCR <- attr(plt2_PCR, "fit2") %>% broom::tidy() %>% cbind( attr(plt2_PCR, "fit2") %>% broom::confint_tidy()) %>%
  mutate(`HR` = 1/exp(estimate), LCL = 1/exp(conf.high), UCL = 1/exp(conf.low),
         `p-value` = scales::pvalue(p.value, add_p = T), `p-stars` = pstars(p.value),
         factor = str_remove_all(term, "Severity") %>% factor(levels = levels(DB2_PCR$`Severity`))) %>%
  mutate(label = "HR = " %+% limit_between(`HR`) %+% 
           " [" %+% limit_between(`LCL`) %+% " - " %+% limit_between(`UCL`) %+% "]\nLog-rank: " %+%
           `p-value`)

plt2_PCR <- plt2_PCR + scale_color_brewer("Severity", palette = "Set2", direction = 1,
                                  aesthetics = c("color", "fill"),
                                  labels = c("asymptomatic or mild vs.", "moderate to critical:")) +
  scale_x_continuous("Time to first negative RT-PCR (days)",
                     expand = expand_scale(mult=0.01),
                    limits=c(0, 49), breaks=seq(0, 49, 7))+
  scale_y_continuous("Proportion of cases (%)", expand = expand_scale(mult=0.01),
                     breaks = seq(0, 1, 0.1), labels = scales::percent_format(1) ) +
  # guides(color = guide_legend(label.vjust = 0, keyheight = unit(5, "mm"), ))+
  theme(legend.key.width = unit(10, "mm")) +
  annotate("text", x=28, y=0.77, hjust=0, vjust=1, label = hr.table_PCR$label[1], size=3, fontface = 'italic')
  

plt2_PCR
ggsave("KM2_PCR.png", plt2_PCR, device = "png", height=3, width=5, units = "in", dpi=600)


cat("\n\n")
cat(fig_caption("KM PCR 2", "Reverse cummulative distribution (Kaplan Meier) plot of RT-PCR negativation rate by time since confirmation and severity. Dates were calculated to the first negative PCR result. Also shown: inverse hazard-ratio comparing more severe forms to asymptomatic - mild, with 95% CI and log-rank test."))
cat("\n\n")

# attr(plt2_PCR, "fit") %>% summary(times= c(7, 14, 21, 28))
# #attr(plt2_PCR, "fit")
# summary(attr(plt2_PCR, "fit"))$table
```

## IgM and IgG by time and severity

Both IgM and IgG showed an upwards trend with time since confirmation of the infection, more pronounced for IgG values and in patients with a more severe clinical form (Figure 2). As the time-dependent increase in both IgG and IgM values remained visible after independently factoring in several other variables (ICU admission, age >50 years, lethal outcome), we expect it to be genuine, so we only showed plots with severity. Both antibody types had higher average and higher variability in patients with more severe cases, suggesting that severity is linked to a higher immune reactivity, at least in a subset of patients.

```{r echo=F, fig.height=3, fig.width=5, message=F, warning=F, dpi=600, results="asis", include=T}

plt_IgM <- DB %>% #select(c("IgM", "Days since confirmation", "FO")) %>% na.omit() %>%
  filter(!is.na(`Severity`)) %>%
  ggplot(aes(x=`Days since confirmation`)) + 
  facet_wrap(.~`Severity`, labeller = labeller(`Severity` = label_prefix(my_prefix = metadata.var_to_labels("Severity", metadata), sep = ": ", wrap=25))) +
  geom_point(aes(y=`IgM`, shape=`IgM`>0.8), size=1, alpha=0.5) +
  geom_line(aes(y=`IgM`, group=`FO`, color=as.Date(`Confirmation date`)), size=1/3, alpha=0.5) +
  #geom_smooth(data=mean.log.IgM, aes(y=2^`mean.log.IgM`), method = lm)+
  # geom_line(data=mean.log.IgM, inherit.aes = F, aes(x = `Days since confirmation`, y=2^`mean.log.IgM`)) +
  # stat_summary(aes(y=`IgM`, x=`Days since confirmation`), geom = "pointrange")+
  stat_summary(aes(y=`IgM`, x=`Days since confirmation`), geom = "line")+
  geom_smooth(aes(y=`IgM`), method = lm, color="red")+
  #stat_count(aes(y = ..count..), geom="line", color="blue") +
  #scale_y_log10()+ annotation_logticks(base = 10, sides = "l", scaled = T) +
  scale_y_log10("Log IgM", breaks = 2^c(-2:10), labels = c("1/"%+%2^c(2:1), 2^c(0:10)), limits=c(0.25, 256)) +
  no.minor_grid.y +
  scale_shape_circlefill() +
  scale_colour_gradient2_tableau("Days since confirmation", palette = "Temperature Diverging", trans="date",
                                 limits =as.Date.character(c("2020-03-01", "2020-09-01")))+
  guides(shape=F, 
         color=F
         # guide_colorsteps(show.limits = F, even.steps = F, ticks = 7, 
         #                        draw.ulim=T, draw.llim=T, direction="horizontal", title.position="top",
         #                        barwidth=unit(40, "mm"))
         ) +  
  legend.top_left+
  scale_x_continuous("Days since confirmation", limits = c(-0.5, 31), breaks = seq(0, 100, 7)) + 
  no.minor_grid.x 


# rr.table
beta.labels = data.frame(`Severity` = levels(DB$`Severity`)) %>% set_colnames(c("Severity"))
for (lev in beta.labels$`Severity`) {
  
  data = DB %>% filter(`Severity` == lev) %>%
    filter(`Days since confirmation`<31)
  fit <- lm(data = data, log2(`IgM`)~`Days since confirmation`)
  beta.table <- broom::tidy(fit) %>% cbind( broom::confint_tidy(fit) ) %>%
    mutate(`p-value` = scales::pvalue(p.value, add_p = T), `p-stars` = pstars(p.value)) %>%
    mutate(label = scales::number(`estimate`, 0.001) %+% 
             " [" %+% scales::number(`conf.low`, 0.001) %+% " - " %+% scales::number(`conf.high`, 0.001) %+% "] " %+%
             `p-stars`)
  beta.labels$label[beta.labels$`Severity` == lev] = "beta = " %+% beta.table$label[2]
  
}

plt_IgM <- plt_IgM + #labs(subtitle = "RR = " %+% rr.table$label[2])
  geom_text(data=beta.labels, aes(label=`label`), x=0, y=log10(180), size=3, hjust=0, vjust=0)
plt_IgM
ggsave("IgM.png", plt_IgM, device = "png", height=3, width=5, units = "in", dpi=600)

```

```{r echo=F, fig.height=3, fig.width=5, message=F, warning=F, dpi=600, results="asis", include=T}

plt_IgG <- DB %>% #select(c("IgG", "Days since confirmation", "FO")) %>% na.omit() %>%
  filter(!is.na(`Severity`)) %>%
  ggplot(aes(x=`Days since confirmation`)) + 
  facet_wrap(.~`Severity`, labeller = labeller(`Severity` = label_prefix(my_prefix = metadata.var_to_labels("Severity", metadata), sep = ": ", wrap=25))) +
  geom_point(aes(y=`IgG`, shape=`IgG`>0.8), size=1, alpha=0.5) +
  geom_line(aes(y=`IgG`, group=`FO`, color=as.Date(`Confirmation date`)), size=1/3, alpha=0.5) +
  #geom_smooth(data=mean.log.IgG, aes(y=2^`mean.log.IgG`), method = lm)+
  # geom_line(data=mean.log.IgG, inherit.aes = F, aes(x = `Days since confirmation`, y=2^`mean.log.IgG`)) +
  # stat_summary(aes(y=`IgG`, x=`Days since confirmation`), geom = "pointrange")+
  stat_summary(aes(y=`IgG`, x=`Days since confirmation`), geom = "line")+
  geom_smooth(aes(y=`IgG`), method = lm, color="red")+
  #stat_count(aes(y = ..count..), geom="line", color="blue") +
  #scale_y_log10()+ annotation_logticks(base = 10, sides = "l", scaled = T) +
  scale_y_log10("Log IgG", breaks = 2^c(-2:10), labels = c("1/"%+%2^c(2:1), 2^c(0:10)), limits=c(0.25, 256)) +
  no.minor_grid.y +
  scale_shape_circlefill() +
  scale_colour_gradient2_tableau("Days since confirmation", palette = "Temperature Diverging", trans="date",
                                 limits =as.Date.character(c("2020-03-01", "2020-09-01")))+
  guides(shape=F, 
         color=F
         # guide_colorsteps(show.limits = F, even.steps = F, ticks = 7, 
         #                        draw.ulim=T, draw.llim=T, direction="horizontal", title.position="top",
         #                        barwidth=unit(40, "mm"))
         ) +  
  legend.top_left+
  scale_x_continuous("Days since confirmation", limits = c(-0.5, 31), breaks = seq(0, 100, 7)) + 
  no.minor_grid.x 


# rr.table
beta.labels = data.frame(`Severity` = levels(DB$`Severity`)) %>% set_colnames(c("Severity"))
for (lev in beta.labels$`Severity`) {
  
  data = DB %>% filter(`Severity` == lev) %>%
    filter(`Days since confirmation`<31)
  fit <- lm(data = data, log2(`IgG`)~`Days since confirmation`) 
  beta.table <- broom::tidy(fit) %>% cbind( broom::confint_tidy(fit) ) %>%
    mutate(`p-value` = scales::pvalue(p.value, add_p = T), `p-stars` = pstars(p.value)) %>%
    mutate(label = scales::number(`estimate`, 0.001) %+% 
             " [" %+% scales::number(`conf.low`, 0.001) %+% " - " %+% scales::number(`conf.high`, 0.001) %+% "] " %+%
             `p-stars`)
  beta.labels$label[beta.labels$`Severity` == lev] = "beta = " %+% beta.table$label[2]
  
}

plt_IgG <- plt_IgG + #labs(subtitle = "RR = " %+% rr.table$label[2])
  geom_text(data=beta.labels, aes(label=`label`), x=0, y=log10(180), size=3, hjust=0, vjust=0)
plt_IgG
ggsave("IgG.png", plt_IgG, device = "png", height=3, width=5, units = "in", dpi=600)


cat("\n\n")
cat(fig_caption("antibody trends", "Averaged and plotted against time since confirmation date, both IgM and IgG values showed an upwoards linear trend, more pronounced in severe compared to milder forms, and in IgG compared to IgM. Log y axis; repeated measurements are joined by thin lines; linear regression line with SE; beta coefficient (log titre change per day)."))
cat("\n\n")


```

## RT-PCR positivity rate by time and clinical form

The highest number of RT-PCR and antibody tests were performed during the the first 2 weeks since confirmation. Few patients had follow-up longer then 1 month. Their data was still included in the calculations, but the effect on the overall results is negligible (Figure 3, all panels, histogram and right Y axis). 
RT-PCR positivity rate decreased faster among patients with milder forms to approximately 60% in milder cases and 70% in more severe cases at 14 days after confirmation. At 1 month, approximately 25% of the tests performed in milder cases were negative, compared to approximately 50% in more severe cases (Figure 3a).
Both antibodies showed an upwards trend in positivity rate across time. Patients with a more severe presentation had relatively higher rate of positivity after 2-4 weeks as well as after the first few days since confirmation. A smaller proportion of patients had detectable levels of IgM compared to IgG in asymptomatic or mild cases, while IgG became positive after 1 month in almost all patients, regardless of severity (Figure 3b and 3c).

```{r echo=F, fig.height=3, fig.width=5, message=F, warning=F, dpi=144, results="asis", include=T}

DB2_PCR <- DB %>% select(c("RT - PCR", "Days since confirmation", "Severity")) %>% na.omit() %>% #summary
  group_by(`Severity`, `Days since confirmation`, `RT - PCR`) %>%
  summarise(`detectable` = n()) %>%
  tidyr::spread("RT - PCR", "detectable") %>%
  na.replace(0) %>%
  mutate(`tests` = `detectable` + `negative`, 
         `proportion detectable` = `detectable` / `tests`,
         `LCL` = binom.test(`detectable`, `tests`)$conf.int[1],
         `UCL` = binom.test(`detectable`, `tests`)$conf.int[2]) 

plt_PCR2 <- DB2_PCR %>% ggplot(aes(x=`Days since confirmation`, y=`proportion detectable` )) +  
  facet_wrap(.~`Severity`, labeller = labeller(`Severity` = label_prefix(my_prefix = metadata.var_to_labels("Severity", metadata), sep = ": ", wrap=25))) +
  geom_line() +
  geom_point(aes(size=`tests`)) +
  scale_size_area(max_size = 4)+ guides(size=F)+
  geom_linerange(aes(ymin=`LCL`, ymax=`UCL`), size=0.1) +
  geom_smooth(aes(weight=`tests`), color="red", method = glm, method.args = list(family=binomial(link="probit")))+
  geom_col(aes(y=`tests`/max(`tests`)/4), alpha=0.5, width = 0.75) +
  # geom_point(data = DB %>% mutate(`RT - PCR` = ifelse(`RT - PCR` == "detectable", 1, 0)), 
  #            aes(x = `Days since confirmation`, y = `RT - PCR`), 
  #            alpha=0.05)+
  # geom_smooth(data = DB %>% mutate(`RT - PCR` = ifelse(`RT - PCR` == "detectable", 1, 0)),
  #            aes(x = `Days since confirmation`, y = `RT - PCR`),
  #            color="green", method = glm, method.args = list(family=binomial(link="probit")))+
  scale_x_continuous(limits = c(-0.5, 31), breaks = seq(0, 100, 7)) + no.minor_grid.x +
  scale_y_continuous("% detectable RT - PCR", labels = scales::percent_format(1),
                     limits=c(0, 1.1), breaks =seq(0, 1, 0.25),
                     sec.axis = sec_axis("Tests performed", trans=function(x){x*4*max(DB2_PCR$`tests`)},
                                         breaks = seq(0, 100, 25))) +
  theme(axis.title.y.right = element_text(hjust=0, angle = 90))

# rr.table
rr.labels = data.frame(`Severity` = levels(DB2_PCR$`Severity`)) %>%
  set_colnames(c("Severity"))
for (lev in rr.labels$`Severity`) {
  
  data = DB2_PCR %>% filter(`Severity` == lev)
  fit <- glm(data=data, formula=`proportion detectable`~`Days since confirmation`, weights = `tests`,
      family=binomial(link="probit"))# %>%
  
  rr.table <- broom::tidy(fit) %>% cbind( broom::confint_tidy(fit) ) %>%
    mutate(`RR` = exp(estimate), UCL = exp(conf.high), LCL = exp(conf.low),
           `p-value` = scales::pvalue(p.value, add_p = T), `p-stars` = pstars(p.value)) %>%
    mutate(label = limit_between(`RR`) %+% 
             " [" %+% limit_between(`LCL`) %+% " - " %+% limit_between(`UCL`) %+% "] " %+%
             `p-stars`)
  rr.labels$label[rr.labels$`Severity` == lev] = "RR = " %+% rr.table$label[2]
  
}

plt_PCR2 <- plt_PCR2 + #labs(subtitle = "RR = " %+% rr.table$label[2])
  geom_text(data=rr.labels, aes(label=`label`), x=0, y=1.05, size=3, hjust=0, vjust=0)
plt_PCR2
ggsave("detectabil_PCR2.png", plt_PCR2, device = "png", height=3, width=5, units = "in", dpi=600)


```

```{r echo=F, fig.height=3, fig.width=5, message=F, warning=F, dpi=600, results="asis", include=T}


DB2_IgM2 <- DB %>% select(c("IgM", "Days since confirmation", "Severity")) %>% na.omit() %>% 
  mutate(`IgM` = ifelse(is.na(`IgM`), NA, ifelse(`IgM`>0.8, "detectable", "negative") )) %>%
  group_by(`Severity`,`Days since confirmation`, `IgM`) %>%
  summarise(`detectable` = n()) %>%
  tidyr::spread("IgM", "detectable") %>%
  na.replace(0) %>%
  mutate(`tests` = `detectable` + `negative`, 
         `proportion detectable` = `detectable` / `tests`,
         `LCL` = binom.test(`detectable`, `tests`)$conf.int[1],
         `UCL` = binom.test(`detectable`, `tests`)$conf.int[2])

plt_IgM2 <- DB2_IgM2 %>% ggplot(aes(x=`Days since confirmation`, y=`proportion detectable` )) + 
  facet_wrap(.~`Severity`, labeller = labeller(`Severity` = label_prefix(my_prefix = metadata.var_to_labels("Severity", metadata), sep = ": ", wrap=25))) +
  geom_line() +
  geom_point(aes(size=`tests`)) +
  scale_size_area(max_size = 4)+ guides(size=F) +
  geom_linerange(aes(ymin=`LCL`, ymax=`UCL`), size=0.1) +
  geom_smooth(aes(weight=`tests`), color="red", method = glm, method.args = list(family=binomial(link="probit")))+
  geom_col(aes(y=`tests`/max(`tests`)/4), width = 0.75, alpha=0.5) +
  scale_x_continuous("Days since confirmation", limits = c(-0.5, 31), breaks = seq(0, 100, 7)) + 
  no.minor_grid.x +
  scale_y_continuous("% detectable IgM (> 0.8)", labels = scales::percent_format(1),
                     limits=c(0, 1.1), breaks =seq(0, 1, 0.25),
                     sec.axis = sec_axis("Tests performed", trans=function(x){x*4*max(DB2_IgM2$`tests`)},
                                         breaks = seq(0, 100, 25))) +
  theme(axis.title.y.right = element_text(hjust=0, angle = 90))


# rr.table
rr.labels = data.frame(`Severity` = levels(DB2_IgM2$`Severity`)) %>%
  set_colnames(c("Severity"))
for (lev in rr.labels$`Severity`) {
  
  data = DB2_IgM2 %>% filter(`Severity` == lev)
  fit <- glm(data=data, formula=`proportion detectable`~`Days since confirmation`, weights = `tests`,
      family=binomial(link="probit"))# %>%
  
  rr.table <- broom::tidy(fit) %>% cbind( broom::confint_tidy(fit) ) %>%
    mutate(`RR` = exp(estimate), UCL = exp(conf.high), LCL = exp(conf.low),
           `p-value` = scales::pvalue(p.value, add_p = T), `p-stars` = pstars(p.value)) %>%
    mutate(label = limit_between(`RR`) %+% 
             " [" %+% limit_between(`LCL`) %+% " - " %+% limit_between(`UCL`) %+% "] " %+%
             `p-stars`)
  rr.labels$label[rr.labels$`Severity` == lev] = "RR = " %+% rr.table$label[2]
  
}

plt_IgM2 <- plt_IgM2 + #labs(subtitle = "RR = " %+% rr.table$label[2])
  geom_text(data=rr.labels, aes(label=`label`), x=0, y=1.05, size=3, hjust=0, vjust=0)
plt_IgM2
ggsave("detectabil_IgM2.png", plt_IgM2, device = "png", height=3, width=5, units = "in", dpi=600)
```

```{r echo=F, fig.height=3, fig.width=5, message=F, warning=F, dpi=600, results="asis", include=T}

DB2_IgG2 <- DB %>% select(c("IgG", "Days since confirmation", "Severity")) %>% na.omit() %>% 
  mutate(`IgG` = ifelse(is.na(`IgG`), NA, ifelse(`IgG`>0.8, "detectable", "negative") )) %>%
  group_by(`Severity`,`Days since confirmation`, `IgG`) %>%
  summarise(`detectable` = n()) %>%
  tidyr::spread("IgG", "detectable") %>%
  na.replace(0) %>%
  mutate(`tests` = `detectable` + `negative`, 
         `proportion detectable` = `detectable` / `tests`,
         `LCL` = binom.test(`detectable`, `tests`)$conf.int[1],
         `UCL` = binom.test(`detectable`, `tests`)$conf.int[2])

plt_IgG2 <- DB2_IgG2 %>% ggplot(aes(x=`Days since confirmation`, y=`proportion detectable` )) + 
  facet_wrap(.~`Severity`, labeller = labeller(`Severity` = label_prefix(my_prefix = metadata.var_to_labels("Severity", metadata), sep = ": ", wrap=25))) +
  geom_line() +
  geom_point(aes(size=`tests`)) +
  scale_size_area(max_size = 4)+ guides(size=F) +
  geom_linerange(aes(ymin=`LCL`, ymax=`UCL`), size=0.1) +
  geom_smooth(aes(weight=`tests`), color="red", method = glm, method.args = list(family=binomial(link="probit")))+
  geom_col(aes(y=`tests`/max(`tests`)/4), width = 0.75, alpha=0.5) +
  scale_x_continuous("Days since confirmation", limits = c(-0.5, 31), breaks = seq(0, 100, 7)) + 
  no.minor_grid.x +
  scale_y_continuous("% detectable IgG (> 0.8)", labels = scales::percent_format(1),
                     limits=c(0, 1.1), breaks =seq(0, 1, 0.25),
                     sec.axis = sec_axis("Tests performed", trans=function(x){x*4*max(DB2_IgG2$`tests`)},
                                         breaks = seq(0, 100, 25))) +
  theme(axis.title.y.right = element_text(hjust=0, angle = 90))


# rr.table
rr.labels = data.frame(`Severity` = levels(DB2_IgG2$`Severity`)) %>%
  set_colnames(c("Severity"))
for (lev in rr.labels$`Severity`) {
  
  data = DB2_IgG2 %>% filter(`Severity` == lev)
  fit <- glm(data=data, formula=`proportion detectable`~`Days since confirmation`, weights = `tests`,
      family=binomial(link="probit"))# %>%
  
  rr.table <- broom::tidy(fit) %>% cbind( broom::confint_tidy(fit) ) %>%
    mutate(`RR` = exp(estimate), UCL = exp(conf.high), LCL = exp(conf.low),
           `p-value` = scales::pvalue(p.value, add_p = T), `p-stars` = pstars(p.value)) %>%
    mutate(label = limit_between(`RR`) %+% 
             " [" %+% limit_between(`LCL`) %+% " - " %+% limit_between(`UCL`) %+% "] " %+%
             `p-stars`)
  rr.labels$label[rr.labels$`Severity` == lev] = "RR = " %+% rr.table$label[2]
  
}

plt_IgG2 <- plt_IgG2 + #labs(subtitle = "RR = " %+% rr.table$label[2])
  geom_text(data=rr.labels, aes(label=`label`), x=0, y=1.05, size=3, hjust=0, vjust=0)
plt_IgG2
ggsave("detectabil_IgG2.png", plt_IgG2, device = "png", height=3, width=5, units = "in", dpi=600)
```

```{r echo=F, fig.height=3, fig.width=5, message=F, warning=F, dpi=600, results="asis", include=T}

cat("\n\n")
cat(fig_caption("positivity rate", "The proportion of patients found with detectable IgM (>0.8), IgG (>0.8) and RT-PCR results (uncertain results removed), by time since confirmation (first month) and clinical severity (mild: asymptomatic to mild; severe: intermediate to critical). Also shown: weighted probit regression line, risk-ratio change per day, number of tests performed (dot area and bottom histogram with right y-axis) and binomial 95% confidence interval around average proportion."))
cat("\n\n")
```

## IgM and IgG reactivity

Both antibodies had higher average and higher variability in patients with more severe forms, suggesting that severity is linked to a higher immune reactivity, at least in a subset of patients (Figure 2). In order to classify patients into high vs. lower reactivity, we chose an additional threshold for antibody titer at the 75% quartile of all IgM and IgM measurements, respectively (2.607 for IgM, 2.906 for IgG). As expected, patients in the robust reactivity groups were mostly men, significantly older and had a more severe presentation, higher fatality rate and longer hospital stay (Tables 3 and 4).

```{r echo=F, fig.height=3, fig.width=5, message=F, warning=F, dpi=600, results="asis", include=T}
cat("\n\n")
cat(tab_caption("t.reactivity.IgM", "Sample characteristics by IgM reactivity, defined as high if at least 1 measurement was above the 75% quartile af all IgM measurements in the database (2.607 for IgM)."))
cat("\n\n")

dates = metadata$Var[metadata$Role %in% c("date")]
dates = dates[dates %in% colnames(database)]

database %>% 
  #select(-c(dates, "FO", "Exclude", my.groups$`Test 1`, my.groups$`Test 2`, my.groups$`Test 3`)) %>%
  # mutate(`AgeCategory` = cut(`Age (years)`, breaks = c(-Inf, 50, Inf ), labels = c("<50"," >50"))) %>%
  # mutate_at(c("Sex", "AgeCategory"), forcats::fct_rev) %>%
  
  mutate(`Sex` = forcats::fct_rev(`Sex`), 
         `Sex: male` = forcats::fct_recode(`Sex`, yes="M", no="F"),
         `Outcome: deceased` = forcats::fct_recode(`Outcome`, yes="deceased", no="alive"),
         `CT: crazy paving and/or ground-glass opacities` = forcats::fct_recode(`CT scan`, 
              yes=levels(database$`CT scan`)[1], no=levels(database$`CT scan`)[2]),
         `CT: >30% lung area damage` = forcats::fct_recode(`CT - Lung damage`, 
              yes=levels(database$`CT - Lung damage`)[1], no=levels(database$`CT - Lung damage`)[2]), 
         `IgM reactivity` = forcats::fct_recode(`IgM >2.6`, `high`="yes", `low`="no")) %>%
  
  select(c("IgM reactivity", "Age (years)", 
           "Sex", #"Sex: male", 
           "Severity", "Outcome: deceased", "ICU","Hospitalization (days)",
           "CT: crazy paving and/or ground-glass opacities", "CT: >30% lung area damage")) %>% 
  make_summary_table(g.rows = c("mean_sd", "med_range"), 
                     #g.rows = c("N%", "mean_sd", "geo_mean", "med_range", "med_iqr"), 
                     med_range_string = "M (range)",
                     dep="IgM reactivity",
                     bold_signif = F,
                     footnote = list(lang="en", values = c("mean_sd", "med_range", "MW", "OR")),
                     header=list(lang="en", columns = c("Factor", "Levels", "Statistics"),
                                 labels = list(`Factor` = "", `Levels` = "", `Statistics` = "")),
                     metadata = metadata)

```

```{r echo=F, fig.height=4, fig.width=7, message=F, warning=F, dpi=144, results="asis", include=T}
cat("\n\n")
cat(tab_caption("t.reactivity.IgG", "Sample characteristics by IgG reactivity, defined as high if at least 1 measurement was above the 75% quartile af all IgG measurements in the database (2.906 for IgG)."))
cat("\n\n")

dates = metadata$Var[metadata$Role %in% c("date")]
dates = dates[dates %in% colnames(database)]

database %>% 
  #select(-c(dates, "FO", "Exclude", my.groups$`Test 1`, my.groups$`Test 2`, my.groups$`Test 3`)) %>%
  # mutate(`AgeCategory` = cut(`Age (years)`, breaks = c(-Inf, 50, Inf ), labels = c("<50"," >50"))) %>%
  # mutate_at(c("Sex", "AgeCategory"), forcats::fct_rev) %>%
  
  mutate(`Sex` = forcats::fct_rev(`Sex`), 
         `Sex: male` = forcats::fct_recode(`Sex`, yes="M", no="F"),
         `Outcome: deceased` = forcats::fct_recode(`Outcome`, yes="deceased", no="alive"),
         `CT: crazy paving and/or ground-glass opacities` = forcats::fct_recode(`CT scan`, 
              yes=levels(database$`CT scan`)[1], no=levels(database$`CT scan`)[2]),
         `CT: >30% lung area damage` = forcats::fct_recode(`CT - Lung damage`, 
              yes=levels(database$`CT - Lung damage`)[1], no=levels(database$`CT - Lung damage`)[2]), 
         `IgG reactivity` = forcats::fct_recode(`IgG >2.9`, `high`="yes", `low`="no")) %>%
  
  select(c("IgG reactivity", "Age (years)", 
           "Sex", #"Sex: male", 
           "Severity", "Outcome: deceased", "ICU","Hospitalization (days)",
           "CT: crazy paving and/or ground-glass opacities", "CT: >30% lung area damage")) %>% 
  make_summary_table(g.rows = c("mean_sd", "med_range"), 
                     #g.rows = c("N%", "mean_sd", "geo_mean", "med_range", "med_iqr"), 
                     med_range_string = "M (range)",
                     dep="IgG reactivity",
                     bold_signif = F,
                     footnote = list(lang="en", values = c("mean_sd", "med_range", "MW", "OR")),
                     header=list(lang="en", columns = c("Factor", "Levels", "Statistics"),
                                 labels = list(`Factor` = "", `Levels` = "", `Statistics` = "")),
                     metadata = metadata)
```

## Concordane PCR and antibodies

```{r echo=F, fig.height=3, fig.width=5, message=F, warning=F, dpi=600, results="asis", include=F}
p1 <- DB %>% filter(`Days since confirmation`>14) %>%
  mutate(`Severity` = forcats::fct_rev(`Severity`)) %>%
  filter(`Days since confirmation`>14) %>%
  my_box(y="IgM", x="RT - PCR", z="Severity", metadata=metadata_DB, 
              vio=F, vio.scale_factor = 1, vio.dodge = 1) +
  scale_fill_brewer("Severity", palette = "Set2", direction=1, aesthetics = c("fill", "color")) 

p2 <- DB %>% filter(`Days since confirmation`>14) %>%
  mutate(`Severity` = forcats::fct_rev(`Severity`)) %>%
  my_box(y="IgG", x="RT - PCR", z="Severity", metadata=metadata_DB,
              vio=F, vio.scale_factor = 1, vio.dodge = 1) +
  scale_fill_brewer("Severity", palette = "Set2", direction=1, aesthetics = c("fill", "color"))

cowplot::plot_grid(cowplot::get_legend(p1+legend.top), 
                   cowplot::plot_grid(p1+no_legend, p2+no_legend),
                   nrow=2, rel_heights = c(1, 10))

cat("\n\n")
cat(fig_caption("igm igg by pcr", "IgM and IgG titre by RT-PCR result and clinical severity after 14 days since confirmation."))
cat("\n\n")

```

```{r echo=F, fig.height=3, fig.width=5, message=F, warning=F, dpi=600, results="asis", include=F}

cat("\n\n")
cat(tab_caption("t concordance pcr igm ing", "Concordance between RT-PCR, detectable IgM and detectable IgG titre (>0.8) after 14 days since confirmation."))
cat("\n\n")

DB %>% filter(`Days since confirmation`>14) %>%
  mutate(`IgM` = ifelse(is.na(`IgM`), NA, ifelse(`IgM`<0.8, "negative", "detectable")) %>%
                factor(levels = c("detectable", "negative"))) %>%
  contingency.table(row.var = "IgM", col.var = "RT - PCR", structure = c("#", "%"), acc=T, se=T, sp=T)

cat("\n\n\n\n") 

DB %>% filter(`Days since confirmation`>14) %>%
  mutate(`IgG` = ifelse(is.na(`IgG`), NA, ifelse(`IgG`<0.8, "negative", "detectable")) %>%
                factor(levels = c("detectable", "negative"))) %>%
  contingency.table(row.var = "IgG", col.var = "RT - PCR", structure = c("#", "%"), acc=T, se=T, sp=T)

cat("\n\n.\n\n")

DB %>% filter(`Days since confirmation`>14) %>%
  mutate(`IgM` = ifelse(is.na(`IgM`), NA, ifelse(`IgM`<0.8, "negative", "detectable")) %>%
                factor(levels = c("detectable", "negative"))) %>%
  mutate(`IgG` = ifelse(is.na(`IgG`), NA, ifelse(`IgG`<0.8, "negative", "detectable")) %>%
                factor(levels = c("detectable", "negative"))) %>%
  contingency.table(row.var = "IgG", col.var = "IgM", structure = c("#", "%"), acc=T, se=T, sp=T)

```

```{r echo=F, fig.height=3, fig.width=5, message=F, warning=F, dpi=600, results="asis", include=F}
DB %>% filter(`Days since confirmation`>14) %>%
  mutate(`IgM` = ifelse(is.na(`IgM`), NA, ifelse(`IgM`<1.2, "negative", "detectable")) %>%
                factor(levels = c("detectable", "negative"))) %>%
  mutate(`IgG` = ifelse(is.na(`IgG`), NA, ifelse(`IgG`<1.2, "negative", "detectable")) %>%
                factor(levels = c("detectable", "negative"))) %>%
  mutate_at(c("RT - PCR", "IgM", "IgG"), forcats::fct_recode, `+` = "detectable", `-`="negative") %>%
  mutate(`RT-PCR & IgM` = `RT - PCR` %+% "/" %+% `IgM`,
         `RT-PCR & IgG` = `RT - PCR` %+% "/" %+% `IgG`,
         `IgM & IgG` = `IgM` %+% "/" %+% `IgG`) %>%
  #mutate_at(c("RT-PCR & IgM", "RT-PCR & IgG", "IgM & IgG"), factor, levels=c("+/+", "-/+", "+/-", "-/-")) %>%
  select(c("RT-PCR & IgM", "RT-PCR & IgG", "IgM & IgG", "Severity")) %>%
  tidyr::gather("column", "val", -c("Severity")) %>%
  mutate(`val` = factor(`val`, levels=c("+/+", "-/+", "+/-", "-/-"))) %>% na.omit() %>%
  ggplot(aes(x=`column`, y=`val`))+
  geom_col(aes(fill=`val`)) + 
  #geom_text(aes(label=val)) + 
  legend.top

```

```{r echo=F, fig.height=3, fig.width=5, message=F, warning=F, dpi=600, results="asis", include=F}

db <- database %>%
  select(c("Outcome", "Age (years)", "Sex", "CT - Lung damage", "IgM >2.6", "IgG >2.9")) %>% #, "ICU"
  mutate_at("Age (years)", function(x){x/10} ) %>%
  mutate_if(is.binary, forcats::fct_rev) %>%
  mutate_at(c("Outcome"), forcats::fct_rev) %>%
  na.omit()
colnames(db) = makeNames(colnames(db))
fit <- glm(data=db, formula = `Outcome` ~ ., family = binomial())
fit.step <- step(fit)

sjPlot::plot_models(fit, fit.step, 
                    prefix.labels = "label", 
                    show.p = T, show.values = T, value.size = 3,
                    m.labels = c("Full model", "Stepwise"), legend.title = "") + 
  legend.top
sjPlot::tab_model(fit, fit.step, dv.labels = c("Full model", "Stepwise"))

database %>% make_summary_table(dep="Outcome", prefer = "non-parametric")

```


# KM plots

```{r my_surv_plot, echo=F, fig.height=3, fig.width=5, message=F, warning=F, dpi=600, results="asis", include=F}
require("survival")

my_surv_plot <- function(DB2, Time, by = NA, Status = NA, Status_event="dead",
                         # sf_times = c(7, 14, 21, 28),
                         hr_config_ord = "vs first", # "vs last"
                         hr_config_bin = "vs second", 
                         show_logrank = T,
                         surv.connect = T, conf.int = T, conf.int.alpha = 0.1,
                         censor = T, censor.size = 2.5, censor.shape = "|", 
                         lwd=1, median.lwd=0.5, median.linetype = "dashed",
                         metadata = NULL) {
  # by="Clinical form"
  
  # make a censor variable named Status, either all not censored, or from a named variable
  if (is.na(Status)) {
    DB2$Status = T # all ok
  } else {
    DB2$Status = DB2[[Status]] == Status_event # TRUE if ok, false if censored
  } 
  
  db <- DB2 %>% 
    select(c(Time, Status, by)) %>%
    mutate(nothing = "") %>%
    set_colnames(c("Time", "Status", make.names(by), "nothing")) %>% 
    na.omit() %>% droplevels()
  #summary(db)
  
  ## fit: regular log-rank test
  fit <- with(db, survfit(formula=as.formula("Surv(time = `Time`, event = `Status`) ~ " %+% make.names(by)) ))
  test <-with(db, survival::survdiff(as.formula("Surv(time = `Time`, event = `Status`) ~ " %+% make.names(by))))
  LR.p <- pchisq(test$chisq, length(test$n)-1, lower.tail = F)
  
  # sf <- summary(fit, times=sf_times)
  #print(sf)
  #sf$table %>% as.data.frame()
  # sf <- summary(fit)
  
  surv_median <- as.vector(summary(fit)$table[, "median"])
  df_fit <- data.frame(
    strata2 = names(fit$strata) %>% str_remove_all(make.names(by) %+% "="),
    x1 = surv_median, x2 = surv_median, 
    y1 = rep(0, length(surv_median)), 
    y2 = rep(0.5, length(surv_median)))
  
  
  
  ## fit2: coxh regression
  levs <- levels(DB2[[by]])
  if(length(levs) > 2) {
    if (hr_config_ord == "vs first") { # compare all levels to the first (default)
      db2 <- db
    } else if (hr_config_ord == "vs last") {
      db2 <- db %>% mutate_at(c( make.names(by)), forcats::fct_rev)
    } 
  } else { #if(length(levs) == 2) {
    if (hr_config_bin == "vs first") { # no vs yes
      db2 <- db
    } else { # if (hr_config_ord == "vs second") { # yes vs no (default)
      db2 <- db %>% mutate_at(c(make.names(by)), forcats::fct_rev)
    }
  }
  fit2 <- with(db2, coxph(formula=as.formula("Surv(time = `Time`, event = `Status`) ~ " %+% make.names(by)) ))
  # text_HR = "HR = " %+% scales::number(exp(fit2$coefficients), 0.001) 
  
  
  ## KM plot
  plt <- autoplot(fit, surv.connect = surv.connect, 
                  size=lwd, # Does not work!!!
                  conf.int = conf.int, conf.int.alpha = conf.int.alpha,
                  censor = censor, censor.size = censor.size, censor.shape = censor.shape) +
    scale_color_discrete(metadata.var_to_labels(by, metadata))+
    scale_fill_discrete(metadata.var_to_labels(by, metadata))+
    # scale_color_viridis_d(by) + scale_fill_viridis_d(by)+
    
    # annotate('text', label=text_HR %+% "\n" %+% text_LR, x = 33.5, y=0.7, size=3, hjust=0) +
    geom_hline(yintercept=0.5, size=0.5, color="grey") +
    geom_vline(aes(xintercept=x1, color=strata2), data=df_fit, linetype = median.linetype, size = median.lwd) 
  
  if (show_logrank == T) {
    plt <- plt + labs(subtitle = "Log-rank test: " %+% scales::pvalue(LR.p, add_p = T) )
    # plt <- plt + labs(y = "Log-rank test: ")
  }
  
  attr(plt, "fit") = fit
  attr(plt, "test") = test
  attr(plt, "p-value") = LR.p
  attr(plt, "fit2") = fit2 # coxh
  
  plt  
  #return (plt)
  
  
  # survminer::pairwise_survdiff(as.formula("Surv(time = `Survival`, event = `Dead`) ~ " %+% make.names(by)), data=db) %>% print()
  
  # db2 <- db %>% filter(Treatment != "Transplant") %>% droplevels()
  # survminer::pairwise_survdiff(as.formula("Surv(time = `Survival`, event = `Dead`) ~ " %+% by), data=db2) %>% print()
  
  

}

last_available <- function(x) {
  x <- na.omit(x)
  if (length(x) == 0) return (NA)
  else return (x[length(x)])
}

first_match_or_last_known <- function(x, pattern = "") {
  x <- na.omit(x)
  y <- grep(x=x, pattern = pattern, value = T )
  # x = x[x == T]
  if (length(y) == 0) return (x[length(x)])
  else return (y[1])
}
```

### PCR

```{r last_status, echo=F, fig.height=3, fig.width=5, message=F, warning=F, dpi=600, results="asis", include=F}

last_status_PCR <- 
  DB %>% select(c("FO", "Days since confirmation", "RT - PCR")) %>%
    na.omit() %>%
    arrange(`FO`, `Days since confirmation`) %>%
    mutate(key = `RT - PCR` %+% " " %+% `Days since confirmation`) %>%
    group_by(`FO`) %>%
    summarise(`key` = first_match_or_last_known(`key`, pattern = "nega")) %>%
    tidyr::separate(col="key", into=c("Stauts at test #5", "Days since confirmation"), convert=T) %>%
    mutate(`Stauts at test #5` = factor(`Stauts at test #5`, levels=c("detectable", "negative")))

DB2_PCR <- database %>%
  select(c("FO", "Clinical form")) %>%
  mutate(`Severity` = forcats::fct_collapse(`Clinical form`, 
                                                 `asymptomatic or mild` = c("asymptomatic", "mild"),
                                                 `moderate to critical` = c("intermediate", "severe", "critical")) %>%
           factor(levels=c("asymptomatic or mild", "moderate to critical")) ) %>%
  mutate(`Severitate` = forcats::fct_collapse(`Clinical form`, 
                                              `asymptomatic` = c("asymptomatic"),
                                              `mild` = c("mild"),
                                              `moderate` = c("intermediate"),
                                              `severe to critical` = c("severe", "critical")) %>%
           factor(levels=c("asymptomatic", "mild", "moderate", "severe to critical"))) %>%
  merge(last_status_PCR, by="FO") 

```

```{r echo=F, fig.height=3, fig.width=5, message=F, warning=F, dpi=600, results="asis", include=F}
plt1_PCR <- DB2_PCR %>%
  my_surv_plot(by="Severitate", Time = "Days since confirmation", 
               Status = "Stauts at test #5", Status_event = "negative",
               conf.int.alpha = 0.025, lwd = 1, median.lwd = 0.33,
               metadata = metadata)


# summary(attr(plt1, "fit2"))
hr.table_PCR <- attr(plt1_PCR, "fit2") %>% broom::tidy() %>% cbind( attr(plt1_PCR, "fit2") %>% broom::confint_tidy()) %>%
  mutate(`HR` = 1/exp(estimate), LCL = 1/exp(conf.high), UCL = 1/exp(conf.low),
         `p-value` = scales::pvalue(p.value, add_p = T), `p-stars` = pstars(p.value),
         factor = str_remove_all(term, "Severitate") %>% factor(levels = levels(DB2_PCR$`Severitate`))) %>%
  mutate(label = limit_between(`HR`) %+% 
           " [" %+% limit_between(`LCL`) %+% " - " %+% limit_between(`UCL`) %+% "] " %+%
           `p-stars`)

plt1_PCR <- plt1_PCR + 
  scale_color_brewer(palette = "Spectral", aesthetics = c("color", "fill"), direction = -1,
  # scale_color_tableau(palette = "Classic Blue-Red 12",  direction = 1,
                      name = "Severitate (1/HR, 95% CI, p)", #aesthetics = c("color", "fill"), 
                      labels = c("asymptomatic vs.", "mild: ", "moderate: ", "severe to critical: ") %+% c("", hr.table_PCR$label)) +
  scale_x_continuous("Durata până la negativarea RT-PCR (zile)",
                     expand = expand_scale(mult=0.01),
                    limits=c(0, 49), breaks=seq(0, 49, 7))+
  scale_y_continuous("Proporția de cazuri (%)", expand = expand_scale(mult=0.01),
                     breaks = seq(0, 1, 0.1), labels = scales::percent_format(1) ) +
  theme(legend.key.width = unit(10, "mm"))
  


plt1_PCR
ggsave("KM1_PCR.png", plt1_PCR, device = "png", height=3, width=5, units = "in", dpi=600)


cat("\n\n")
cat(fig_caption("KM PCR 1", "Reverse cummulative distribution (Kaplan Meier) plot of RT-PCR negativation rate by time since confirmation and severity. Dates were calculated to the first negative PCR result. Also shown: invese hazard-ratio comparing all severities to asymptomatic, with 95% CI and statistical signifficance; overall log-rank test."))
cat("\n\n")


```




```{r echo=F, fig.height=3, fig.width=5, message=F, warning=F, dpi=600, results="asis", include=F}
plt2_PCR <- DB2_PCR %>%
  my_surv_plot(by="Severity", Time = "Days since confirmation", 
               Status = "Stauts at test #5", Status_event = "negative",
               hr_config_bin = "vs first", show_logrank = F,
               conf.int.alpha = 0.1, lwd = 1, median.lwd = 0.33,
               metadata = metadata)


# plt2_PCR
# summary(attr(plt2_PCR, "fit2"))
hr.table_PCR <- attr(plt2_PCR, "fit2") %>% broom::tidy() %>% cbind( attr(plt2_PCR, "fit2") %>% broom::confint_tidy()) %>%
  mutate(`HR` = 1/exp(estimate), LCL = 1/exp(conf.high), UCL = 1/exp(conf.low),
         `p-value` = scales::pvalue(p.value, add_p = T), `p-stars` = pstars(p.value),
         factor = str_remove_all(term, "Severity") %>% factor(levels = levels(DB2_PCR$`Severity`))) %>%
  mutate(label = "HR = " %+% limit_between(`HR`) %+% 
           " [" %+% limit_between(`LCL`) %+% " - " %+% limit_between(`UCL`) %+% "]\nLog-rank: " %+%
           `p-value`)

plt2_PCR <- plt2_PCR + scale_color_brewer("Severity", palette = "Set2", direction = 1,
                                  aesthetics = c("color", "fill"),
                                  labels = c("asymptomatic or mild vs.", "moderate to critical:")) +
  scale_x_continuous("Time to first negative RT-PCR (days)",
                     expand = expand_scale(mult=0.01),
                    limits=c(0, 49), breaks=seq(0, 49, 7))+
  scale_y_continuous("Proportion of cases (%)", expand = expand_scale(mult=0.01),
                     breaks = seq(0, 1, 0.1), labels = scales::percent_format(1) ) +
  # guides(color = guide_legend(label.vjust = 0, keyheight = unit(5, "mm"), ))+
  theme(legend.key.width = unit(10, "mm")) +
  annotate("text", x=28, y=0.77, hjust=0, vjust=1, label = hr.table_PCR$label[1], size=3, fontface = 'italic')
  

plt2_PCR
ggsave("KM2_PCR.png", plt2_PCR, device = "png", height=3, width=5, units = "in", dpi=600)


cat("\n\n")
cat(fig_caption("KM PCR 2", "Reverse cummulative distribution (Kaplan Meier) plot of RT-PCR negativation rate by time since confirmation and severity. Dates were calculated to the first negative PCR result. Also shown: invese hazard-ratio comparing more severe forms to asymptomatic - mild, with 95% CI and log-rank test."))
cat("\n\n")




attr(plt2_PCR, "fit") %>% summary(times= c(7, 14, 21, 28))
#attr(plt2_PCR, "fit")
summary(attr(plt2_PCR, "fit"))$table
```

### IgM

```{r echo=F, fig.height=3, fig.width=5, message=F, warning=F, dpi=600, results="asis", include=F}


last_status_IgM <- 
  DB %>% select(c("FO", "Days since confirmation", "IgM")) %>% na.omit() %>%
    mutate(`IgM positive` = ifelse(`IgM`>0.8, "detectable", "negative")) %>%
    arrange(`FO`, `Days since confirmation`) %>%
    mutate(key = `IgM positive` %+% " " %+% `Days since confirmation`) %>%
    group_by(`FO`) %>%
    summarise(`key` = first_match_or_last_known(`key`, "detectable")) %>% # na.omit() %>%
    tidyr::separate(col="key", into=c("Stauts at test #5", "Days since confirmation"), convert=T) %>%
    mutate(`Stauts at test #5` = factor(`Stauts at test #5`, levels=c("detectable", "negative")))

DB2_IgM <- database %>%
  select(c("FO", "Clinical form")) %>%
  mutate(`Severity` = forcats::fct_collapse(`Clinical form`, 
                                                 `asymptomatic or mild` = c("asymptomatic", "mild"),
                                                 `moderate to critical` = c("intermediate", "severe", "critical")) %>%
           factor(levels=c("asymptomatic or mild", "moderate to critical")) ) %>%
  mutate(`Severitate` = forcats::fct_collapse(`Clinical form`, 
                                              `asymptomatic` = c("asymptomatic"),
                                              `mild` = c("mild"),
                                              `moderate` = c("intermediate"),
                                              `severe to critical` = c("severe", "critical")) %>%
           factor(levels=c("asymptomatic", "mild", "moderate", "severe to critical"))) %>%
  merge(last_status_IgM, by="FO") 
```

```{r echo=F, fig.height=3, fig.width=5, message=F, warning=F, dpi=600, results="asis", include=F}
plt1_IgM <- DB2_IgM %>%
  my_surv_plot(by="Severitate", Time = "Days since confirmation", 
               Status = "Stauts at test #5", Status_event = "detectable",
               conf.int.alpha = 0.025, lwd = 1, median.lwd = 0.33,
               metadata = metadata)


# summary(attr(plt1, "fit2"))
hr.table_IgM <- attr(plt1_IgM, "fit2") %>% broom::tidy() %>% cbind( attr(plt1_IgM, "fit2") %>% broom::confint_tidy()) %>%
  mutate(`HR` = 1/exp(estimate), LCL = 1/exp(conf.high), UCL = 1/exp(conf.low),
         `p-value` = scales::pvalue(p.value, add_p = T), `p-stars` = pstars(p.value),
         factor = str_remove_all(term, "Severitate") %>% factor(levels = levels(DB2_IgM$`Severitate`))) %>%
  mutate(label = limit_between(`HR`) %+% 
           " [" %+% limit_between(`LCL`) %+% " - " %+% limit_between(`UCL`) %+% "] " %+%
           `p-stars`)

plt1_IgM <- plt1_IgM + scale_color_brewer("Severitate (1/HR, 95% CI, p)", palette = "Spectral", aesthetics = c("color", "fill"), direction = -1,
                          labels = c("asymptomatic vs.", "mild: ", "moderate: ", "severe to critical: ") %+%
                            c("", hr.table_IgM$label)) +
  scale_x_continuous("Durata până la pozitivarea IgM (zile)",
                     expand = expand_scale(mult=0.01),
                    limits=c(0, 49), breaks=seq(0, 49, 7))+
  scale_y_continuous("Proporția de cazuri (%)", expand = expand_scale(mult=0.01),
                     breaks = seq(0, 1, 0.1), labels = scales::percent_format(1) ) +
  theme(legend.key.width = unit(10, "mm"))
  


plt1_IgM
ggsave("KM1_IgM.png", plt1_IgM, device = "png", height=3, width=5, units = "in", dpi=600)


cat("\n\n")
cat(fig_caption("KM IgM 1", "Reverse cummulative distribution (Kaplan Meier) plot of IgM positivation rate (first value > 0.8) by time since confirmation and severity. Dates were calculated to the first negative PCR result. Also shown: invese hazard-ratio comparing all severities to asymptomatic, with 95% CI and statistical signifficance; overall log-rank test."))
cat("\n\n")

```

```{r echo=F, fig.height=3, fig.width=5, message=F, warning=F, dpi=600, results="asis", include=F}
plt2_IgM <- DB2_IgM %>%
  my_surv_plot(by="Severity", Time = "Days since confirmation", 
               Status = "Stauts at test #5", Status_event = "detectable",
               hr_config_bin = "vs first", show_logrank = F, 
               conf.int.alpha = 0.1, lwd = 1, median.lwd = 0.33,
               metadata = metadata)


# plt2_IgM
# summary(attr(plt2_IgM, "fit2"))
hr.table_IgM <- attr(plt2_IgM, "fit2") %>% broom::tidy() %>% cbind( attr(plt2_IgM, "fit2") %>% broom::confint_tidy()) %>%
  mutate(`HR` = 1/exp(estimate), LCL = 1/exp(conf.high), UCL = 1/exp(conf.low),
         `p-value` = scales::pvalue(p.value, add_p = T), `p-stars` = pstars(p.value),
         factor = str_remove_all(term, "Severity") %>% factor(levels = levels(DB2_IgM$`Severity`))) %>%
  mutate(label = "HR = " %+% limit_between(`HR`) %+% 
           " [" %+% limit_between(`LCL`) %+% " - " %+% limit_between(`UCL`) %+% "]\nLog-rank: " %+%
           `p-value`)

plt2_IgM <- plt2_IgM + scale_color_brewer("Severitate", palette = "Set2", direction = 1,
                                  aesthetics = c("color", "fill"),
                                  labels = c("asymptomatic or mild vs.", "moderate to critical:")) +
  scale_x_continuous("Durata până la pozitivarea IgM (zile)",
                     expand = expand_scale(mult=0.01),
                    limits=c(0, 49), breaks=seq(0, 49, 7))+
  scale_y_continuous("Proporția de cazuri (%)", expand = expand_scale(mult=0.01),
                     breaks = seq(0, 1, 0.1), labels = scales::percent_format(1) ) +
  # guides(color = guide_legend(label.vjust = 0, keyheight = unit(5, "mm"), ))+
  theme(legend.key.width = unit(10, "mm")) +
  annotate("text", x=26, y=0.77, hjust=0, vjust=1, label = hr.table_IgM$label[1], size=3, fontface = 'italic')
  

plt2_IgM
ggsave("KM2_IgM.png", plt2_IgM, device = "png", height=3, width=5, units = "in", dpi=600)

cat("\n\n")
cat(fig_caption("KM IgM 2", "Reverse cummulative distribution (Kaplan Meier) plot of IgM positivation rate (first value > 0.8) by time since confirmation and severity. Dates were calculated to the first negative PCR result. Also shown: invese hazard-ratio comparing more severe forms to asymptomatic - mild, with 95% CI and log-rank test."))
cat("\n\n")
```


### IgG

```{r echo=F, fig.height=3, fig.width=5, message=F, warning=F, dpi=600, results="asis", include=F}


last_status_IgG <- 
  DB %>% select(c("FO", "Days since confirmation", "IgG")) %>% na.omit() %>%
    mutate(`IgG positive` = ifelse(`IgG`>0.8, "detectable", "negative")) %>%
    arrange(`FO`, `Days since confirmation`) %>%
    mutate(key = `IgG positive` %+% " " %+% `Days since confirmation`) %>%
    group_by(`FO`) %>%
    summarise(`key` = first_match_or_last_known(`key`, "detectable")) %>% # na.omit() %>%
    tidyr::separate(col="key", into=c("Stauts at test #5", "Days since confirmation"), convert=T) %>%
    mutate(`Stauts at test #5` = factor(`Stauts at test #5`, levels=c("detectable", "negative")))

DB2_IgG <- database %>%
  select(c("FO", "Clinical form")) %>%
  mutate(`Severity` = forcats::fct_collapse(`Clinical form`, 
                                                 `asymptomatic or mild` = c("asymptomatic", "mild"),
                                                 `moderate to critical` = c("intermediate", "severe", "critical")) %>%
           factor(levels=c("asymptomatic or mild", "moderate to critical")) ) %>%
  mutate(`Severitate` = forcats::fct_collapse(`Clinical form`, 
                                              `asymptomatic` = c("asymptomatic"),
                                              `mild` = c("mild"),
                                              `moderate` = c("intermediate"),
                                              `severe to critical` = c("severe", "critical")) %>%
           factor(levels=c("asymptomatic", "mild", "moderate", "severe to critical"))) %>%
  merge(last_status_IgG, by="FO") 
```

```{r echo=F, fig.height=3, fig.width=5, message=F, warning=F, dpi=600, results="asis", include=F}
plt1_IgG <- DB2_IgG %>%
  my_surv_plot(by="Severitate", Time = "Days since confirmation", 
               Status = "Stauts at test #5", Status_event = "detectable",
               conf.int.alpha = 0.025, lwd = 1, median.lwd = 0.33,
               metadata = metadata)


# summary(attr(plt1, "fit2"))
hr.table_IgG <- attr(plt1_IgG, "fit2") %>% broom::tidy() %>% cbind( attr(plt1_IgG, "fit2") %>% broom::confint_tidy()) %>%
  mutate(`HR` = 1/exp(estimate), LCL = 1/exp(conf.high), UCL = 1/exp(conf.low),
         `p-value` = scales::pvalue(p.value, add_p = T), `p-stars` = pstars(p.value),
         factor = str_remove_all(term, "Severitate") %>% factor(levels = levels(DB2_IgG$`Severitate`))) %>%
  mutate(label = limit_between(`HR`) %+% 
           " [" %+% limit_between(`LCL`) %+% " - " %+% limit_between(`UCL`) %+% "] " %+%
           `p-stars`)

plt1_IgG <- plt1_IgG + scale_color_brewer("Severitate (1/HR, 95% CI, p)", palette = "Spectral", aesthetics = c("color", "fill"), direction = -1,
                          labels = c("asymptomatic vs.", "mild: ", "moderate: ", "severe to critical: ") %+%
                            c("", hr.table_IgG$label)) +
  scale_x_continuous("Durata până la pozitivarea IgG (zile)",
                     expand = expand_scale(mult=0.01),
                    limits=c(0, 49), breaks=seq(0, 49, 7))+
  scale_y_continuous("Proporția de cazuri (%)", expand = expand_scale(mult=0.01),
                     breaks = seq(0, 1, 0.1), labels = scales::percent_format(1) ) +
  theme(legend.key.width = unit(10, "mm"))
  


plt1_IgG
ggsave("KM1_IgG.png", plt1_IgG, device = "png", height=3, width=5, units = "in", dpi=600)


cat("\n\n")
cat(fig_caption("KM IgG 1", "Reverse cummulative distribution (Kaplan Meier) plot of IgG positivation rate (first value > 0.8) by time since confirmation and severity. Dates were calculated to the first negative PCR result. Also shown: invese hazard-ratio comparing all severities to asymptomatic, with 95% CI and statistical signifficance; overall log-rank test."))
cat("\n\n")

```

```{r echo=F, fig.height=3, fig.width=5, message=F, warning=F, dpi=600, results="asis", include=F}
plt2_IgG <- DB2_IgG %>%
  my_surv_plot(by="Severity", Time = "Days since confirmation", 
               Status = "Stauts at test #5", Status_event = "detectable", 
               hr_config_bin = "vs first", show_logrank = F, 
               conf.int.alpha = 0.1, lwd = 1, median.lwd = 0.33,
               metadata = metadata)


# plt2_IgG
# summary(attr(plt2_IgG, "fit2"))
hr.table_IgG <- attr(plt2_IgG, "fit2") %>% broom::tidy() %>% cbind( attr(plt2_IgG, "fit2") %>% broom::confint_tidy()) %>%
  mutate(`HR` = 1/exp(estimate), LCL = 1/exp(conf.high), UCL = 1/exp(conf.low),
         `p-value` = scales::pvalue(p.value, add_p = T), `p-stars` = pstars(p.value),
         factor = str_remove_all(term, "Severity") %>% factor(levels = levels(DB2_IgG$`Severity`))) %>%
  mutate(label = "HR = " %+% limit_between(`HR`) %+% 
           " [" %+% limit_between(`LCL`) %+% " - " %+% limit_between(`UCL`) %+% "]\nLog-rank: " %+%
           `p-value`)

plt2_IgG <- plt2_IgG + scale_color_brewer("Severitate", palette = "Set2", direction = 1,
                                  aesthetics = c("color", "fill"),
                                  labels = c("asymptomatic or mild vs.", "moderate to critical:")) +
  scale_x_continuous("Durata până la pozitivarea IgG (zile)",
                     expand = expand_scale(mult=0.01),
                    limits=c(0, 49), breaks=seq(0, 49, 7))+
  scale_y_continuous("Proporția de cazuri (%)", expand = expand_scale(mult=0.01),
                     breaks = seq(0, 1, 0.1), labels = scales::percent_format(1) ) +
  # guides(color = guide_legend(label.vjust = 0, keyheight = unit(5, "mm"), ))+
  theme(legend.key.width = unit(10, "mm")) +
  annotate("text", x=26, y=0.77, hjust=0, vjust=1, label = hr.table_IgG$label[1], size=3, fontface = 'italic')
  

plt2_IgG
ggsave("KM2_IgG.png", plt2_IgG, device = "png", height=3, width=5, units = "in", dpi=600)

cat("\n\n")
cat(fig_caption("KM IgG 2", "Reverse cummulative distribution (Kaplan Meier) plot of IgG positivation rate (first value > 0.8) by time since confirmation and severity. Dates were calculated to the first negative PCR result. Also shown: invese hazard-ratio comparing more severe forms to asymptomatic - mild, with 95% CI and log-rank test."))
cat("\n\n")

# hist(database$`Hospitalization (days)`)
# hist(database$`Age (years)`)
# hist(DB$`Days since confirmation`)
```


# Discussion

Due to the legal context in Romania during this study, we included a high proportion of asymptomatic and mild cases (56%) and a very low number of fatal cases. This allowed us to gather important data on cases who would have been otherwise less likely to be studied.

# Conclusion

We included a relatively high number of asymptomatic COVID-19 cases, who had a slightly faster RT-PCR negativity rate compared to moderate to critical patients. In both cases, RT-PCR tests remained positive in half of the patients for approximately 2 weeks after confirmation and were negative in almost all patients after 1 month.
IgG and IgM dynamics were almost simultaneous, sightly more robust for IgG and for more severe cases. At 1 month after confirmation, almost all patients had detectable antibody titres. Both IgM / IgG high reactivity were correlated to older age, disease severity, fatality rate, ICU admissions, longer hospitalization and CT scan abnormalities by no gender difference. Still, men significantly developed a more severe disease.

# References

1. R Core Team (2020). R: A language and environment for statistical computing. R Foundation for Statistical Computing, Vienna, Austria. URL https://www.R-project.org/.
2. Chen, G., Wu, D., Guo, W., Cao, Y., Huang, D., Wang, H., Wang, T., Zhang, X., Chen, H., Yu, H., et al. (2020). Clinical and immunological features of severe and moderate coronavirus disease 2019. J Clin Invest. 130, 2620–2629. doi: 10.1172/JCI137244.
3. European Commission (EC). Communication from the Commission: Guidelines on COVID-19 in vitro diagnostic tests and their performance. Brussels, 15.4.2020 C(2020) 2391 final. Brussels. Available from: https://ec.europa.eu/info/sites/info/files/testing_kits_communication.pdf.
4. CDC. Overview of Testing for SARS-CoV-2 (COVID-19) (updated 21 October). Available at: https://www.cdc.gov/coronavirus/2019-ncov/hcp/testing-overview.html
5. Watson J, Richter A, Deeks J. Testing for SARS-CoV-2 antibodies. BMJ 2020; 370 doi: https://doi.org/10.1136/bmj.m3325 (Published 08 September 2020).
6. Deeks JJ, Dinnes J, Takwoingi Y, Davenport C, Spijker R, Taylor-Phillips S, Adriano A, Beese S, Dretzke J, Ferrante di Ruffano L, Harris IM, Price MJ, Dittrich S, Emperador D, Hooft L, Leeflang MM, Van den Bruel A; Cochrane COVID-19 Diagnostic Test Accuracy Group. Antibody tests for identification of current and past infection with SARS-CoV-2. Cochrane Database Syst Rev. 2020 Jun 25;6(6):CD013652. doi: 10.1002/14651858.CD013652. PMID: 32584464; PMCID: PMC7387103.
7. World Health Organization (WHO), Clinical management of severe acute respiratory infection (SARI) when COVID-19 disease is suspected (2020) updated This document is the update of an interim guidance originally published under the title “Clinical management of severe acute respiratory infection (SARI) when COVID-19 disease is suspected” on 13 March 2020. https://www.who.int/publications/i/item/clinical-management-of-covid-19. 
8. Guan WJ, Ni ZY, Hu Y, et al. China Medical Treatment Expert Group for Covid-19. Clinical characteristics of coronavirus disease 2019 in China. N Engl J Med 2020; NEJMoa2002032. https://www.nejm.org/doi/10.1056/NEJMoa20020325.
9. Livingston E, Bucher K. Coronavirus Disease 2019 (COVID-19) in Italy. JAMA. 2020 Mar 17. pii: 2763401. PubMed: https://pubmed.gov/32181795. Full-text: https://doi.org/10.1001/jama.2020.4344  
10. Wu Z, McGoogan JM. Characteristics of and Important Lessons From the Coronavirus Disease 2019 (COVID-19) Outbreak in China: Summary of a Report of 72314 Cases From the Chinese Center for Disease Control and Prevention. JAMA. 2020 Feb 24. pii: 2762130. PubMed: https://pubmed.gov/32091533. Full-text: 
11. Richardson S, Hirsch JS, Narasimhan M, et al. Presenting Characteristics, Comorbidities, and Outcomes Among 5700 Patients Hospitalized With COVID-19 in the New York City Area. JAMA 2020 Apr 22;323(20):2052-9. PubMed: https://pubmed.gov/32320003. Full-text: https://doi.org/10.1001/jama.2020.6775.
12. WHO Clinical management of COVID-19. https://www.who.int/publications/i/item/clinical-management-of-covid-19. Reference number WHO/2019-nCoV/clinical/2020.5.
13. Wang H, Ai J, Loeffelholz MJ, Tang Y-W, Zhang W. Meta-analysis of diagnostic performance of serology tests for COVID-19: impact of assay design and post-symptom-onset intervals. Emerging Microbes & Infections 2020, VOL. 9. Pages: 2200-2211 https://doi.org/10.1080/22221751.2020.1826362. 
14. Longitudinal observation and decline of neutralizing antibody responses in the three months following SARS-CoV-2 infection in humans. Nat Microbiol (2020). https://doi.org/10.1038/s41564-020-00813-8.
15. COVID-19 Treatment Guidelines Panel. Coronavirus Disease 2019 (COVID-19) Treatment Guidelines. National Institutes of Health. Available at https://www.covid19treatmentguidelines.nih.gov/. Accessed [11.07.2020]. 
16. Atyeo C, Fischinger S, Zohar T et al.  Report Distinct Early Serological Signatures Track with SARS-CoV-2 Survival.  Immunity; 53 (3): 524-532. https://doi.org/10.1016/j.immuni.2020.07.020. 
17. Liu R, Liu X, Yuan L et al. Analysis of adjunctive serological detection to nucleic acid test for severe acute respiratory syndrome coronavirus 2 (SARS-CoV-2) infection diagnosis. Int Immunopharmacol. 2020; 86: 106746. doi: 10.1016/j.intimp.2020.106746.
